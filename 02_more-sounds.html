<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Analog Synthesizer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .synth-case {
            background: #2b2b2b;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border-top: 4px solid #444;
        }

        h2 { margin: 0 0 20px 0; color: #fff; letter-spacing: 1px; }

        .controls-row {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
            background: #222;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label { font-size: 12px; text-transform: uppercase; color: #aaa; letter-spacing: 0.5px; }

        input[type=range] {
            width: 150px;
            accent-color: #ff9d00;
            cursor: pointer;
        }

        select {
            padding: 5px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .piano-container {
            position: relative;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .key {
            border: 1px solid #000;
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background 0.05s, transform 0.05s;
        }

        .white-key {
            width: 50px;
            height: 200px;
            background: #fdfdfd;
            color: #333;
            z-index: 1;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
        }
        
        .white-key.active { 
            background: #e0e0e0; 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
            transform: translateY(2px);
        }

        .black-key {
            width: 32px;
            height: 120px;
            background: linear-gradient(180deg, #333 0%, #000 100%);
            color: white;
            position: absolute;
            z-index: 2;
            margin-left: -16px; 
            border-bottom: 4px solid #111;
        }

        .black-key.active { 
            background: #222;
            border-bottom: 1px solid #111;
            transform: translateY(2px);
        }

        /* Hardcoded positions for black keys relative to left edge */
        .bk-1 { left: 50px; }
        .bk-2 { left: 100px; }
        .bk-3 { left: 200px; }
        .bk-4 { left: 250px; }
        .bk-5 { left: 300px; }
        .bk-6 { left: 400px; }
        .bk-7 { left: 450px; }

        .key-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            opacity: 0.5;
            pointer-events: none;
        }

        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            cursor: pointer;
            color: white;
            flex-direction: column;
        }
        
        .overlay h1 { font-size: 24px; font-weight: normal; }
        .overlay p { color: #aaa; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="overlay" id="overlay">
        <h1>Click to Start Synthesizer</h1>
        <p>Use your keyboard (A-L) to play</p>
    </div>

    <div class="synth-case">
        <h2>Gaussian Analog Synth</h2>
        
        <div class="controls-row">
            <div class="control-group">
                <label>Pitch Instability (Cents)</label>
                <input type="range" id="variance" min="0" max="100" value="15" step="1">
                <span id="varianceVal" style="font-size:12px; color:#ff9d00">15</span>
            </div>

            <div class="control-group">
                <label>Waveform</label>
                <select id="waveform">
                    <option value="sawtooth">Sawtooth (Rich)</option>
                    <option value="square">Square (Retro)</option>
                    <option value="triangle">Triangle (Mellow)</option>
                    <option value="sine">Sine (Pure)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Filter Cutoff</label>
                <input type="range" id="cutoff" min="100" max="5000" value="2000" step="10">
            </div>
        </div>

        <div class="piano-container" id="piano">
            </div>
    </div>

    <script>
        // --- 1. Configuration & State ---
        let audioCtx;
        const activeVoices = {}; // Tracks playing notes
        
        // Extended Note Mapping
        const notes = [
            { note: "C4",  freq: 261.63, type: "white", key: "a" },
            { note: "C#4", freq: 277.18, type: "black", key: "w" },
            { note: "D4",  freq: 293.66, type: "white", key: "s" },
            { note: "D#4", freq: 311.13, type: "black", key: "e" },
            { note: "E4",  freq: 329.63, type: "white", key: "d" },
            { note: "F4",  freq: 349.23, type: "white", key: "f" },
            { note: "F#4", freq: 369.99, type: "black", key: "t" },
            { note: "G4",  freq: 392.00, type: "white", key: "g" },
            { note: "G#4", freq: 415.30, type: "black", key: "y" },
            { note: "A4",  freq: 440.00, type: "white", key: "h" },
            { note: "A#4", freq: 466.16, type: "black", key: "u" },
            { note: "B4",  freq: 493.88, type: "white", key: "j" },
            { note: "C5",  freq: 523.25, type: "white", key: "k" },
            { note: "C#5", freq: 554.37, type: "black", key: "o" },
            { note: "D5",  freq: 587.33, type: "white", key: "l" },
            { note: "D#5", freq: 622.25, type: "black", key: "p" },
            { note: "E5",  freq: 659.25, type: "white", key: ";" } // For US keyboards
        ];

        // --- 2. Math: Box-Muller & Log-Space Calculation ---
        function gaussianRandom() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function getGaussianPitch(baseFreq, varianceCents) {
            if (varianceCents == 0) return baseFreq;
            const z = gaussianRandom(); 
            const deviation = z * varianceCents; 
            // 1200 cents = 1 octave (factor of 2)
            return baseFreq * Math.pow(2, deviation / 1200);
        }

        // --- 3. Audio Engine ---
        function playNote(freq, keyId) {
            if (!audioCtx) return;
            if (activeVoices[keyId]) return; // Monophonic per key

            const variance = document.getElementById('variance').value;
            const waveType = document.getElementById('waveform').value;
            const cutoff = document.getElementById('cutoff').value;
            
            const finalFreq = getGaussianPitch(freq, variance);
            const now = audioCtx.currentTime;

            // 1. Oscillator (Source)
            const osc = audioCtx.createOscillator();
            osc.type = waveType;
            osc.frequency.setValueAtTime(finalFreq, now);

            // 2. Filter (Tone)
            const filter = audioCtx.createBiquadFilter();
            filter.type = "lowpass";
            filter.frequency.setValueAtTime(cutoff, now);
            filter.Q.value = 1; // Slight resonance for flavor

            // 3. Amplifier (Envelope)
            const gainNode = audioCtx.createGain();
            
            // Envelope: Attack (no click) -> Sustain
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.02); // 20ms attack
            
            // Wiring: Osc -> Filter -> Gain -> Output
            osc.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();

            activeVoices[keyId] = { osc, gainNode };
            
            // Visuals
            const el = document.getElementById('key-' + keyId);
            if(el) el.classList.add('active');
        }

        function stopNote(keyId) {
            if (!activeVoices[keyId]) return;

            const { osc, gainNode } = activeVoices[keyId];
            const now = audioCtx.currentTime;

            // Release envelope: Fade out over 0.15s
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            
            osc.stop(now + 0.16);

            delete activeVoices[keyId];

            const el = document.getElementById('key-' + keyId);
            if(el) el.classList.remove('active');
        }

        // --- 4. Setup & Events ---
        
        // Build Piano UI
        const pianoDiv = document.getElementById('piano');
        let whiteCount = 0;
        
        notes.forEach((n, idx) => {
            const div = document.createElement('div');
            div.id = 'key-' + n.key;
            div.classList.add('key');
            
            // Classes for styling
            if (n.type === 'white') {
                div.classList.add('white-key');
                whiteCount++;
            } else {
                div.classList.add('black-key');
                // Positioning logic
                if(idx === 1) div.classList.add('bk-1');
                if(idx === 3) div.classList.add('bk-2');
                if(idx === 6) div.classList.add('bk-3');
                if(idx === 8) div.classList.add('bk-4');
                if(idx === 10) div.classList.add('bk-5');
                if(idx === 13) div.classList.add('bk-6');
                if(idx === 15) div.classList.add('bk-7');
            }

            // Label
            div.innerHTML = `<span class="key-hint">${n.key.toUpperCase()}</span>`;

            // Mouse Interaction
            div.addEventListener('mousedown', () => playNote(n.freq, n.key));
            div.addEventListener('mouseup', () => stopNote(n.key));
            div.addEventListener('mouseleave', () => stopNote(n.key));

            pianoDiv.appendChild(div);
        });

        // Keyboard Interaction
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = e.key.toLowerCase();
            const noteData = notes.find(n => n.key === k);
            if (noteData) playNote(noteData.freq, k);
        });

        window.addEventListener('keyup', (e) => {
            const k = e.key.toLowerCase();
            if (notes.find(n => n.key === k)) stopNote(k);
        });

        // Controls
        const varianceSlider = document.getElementById('variance');
        varianceSlider.addEventListener('input', (e) => {
            document.getElementById('varianceVal').innerText = e.target.value;
        });

        // Audio Context Start
        document.getElementById('overlay').addEventListener('click', function() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            this.style.display = 'none';
        });

    </script>
</body>
</html>
