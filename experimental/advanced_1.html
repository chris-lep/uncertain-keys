<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Pro Synth</title>
    <style>
        :root { --accent: #00d2ff; --bg: #121212; --panel: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .synth-case { background: var(--panel); padding: 25px; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid #333; width: 900px; }
        
        /* Visualizer */
        canvas { width: 100%; height: 100px; background: #000; border-radius: 5px; margin-bottom: 20px; border: 1px solid #444; }

        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .module { background: #252525; padding: 12px; border-radius: 8px; border-top: 2px solid var(--accent); }
        .module h3 { margin: 0 0 10px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); }

        .control { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        label { font-size: 10px; color: #888; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        select { background: #333; color: white; border: 1px solid #444; padding: 4px; border-radius: 4px; width: 100%; }

        .keyboard { position: relative; display: flex; width: fit-content; margin: 10px auto; height: 180px; background: #111; padding: 10px; border-radius: 5px; }
        .key { border-radius: 0 0 5px 5px; cursor: pointer; user-select: none; transition: all 0.1s; position: relative; box-sizing: border-box; }
        .white { width: 45px; height: 160px; background: #eee; border: 1px solid #999; z-index: 1; }
        .white.active { background: var(--accent); transform: translateY(2px); }
        .black { width: 30px; height: 100px; background: #222; position: absolute; z-index: 2; margin-left: -15px; border: 1px solid #000; }
        .black.active { background: #444; transform: translateY(2px); }

        /* Key Mapping */
        .bk0 { left: 45px; } .bk1 { left: 90px; } .bk2 { left: 180px; } .bk3 { left: 225px; } .bk4 { left: 270px; }
        .bk5 { left: 360px; } .bk6 { left: 405px; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; cursor: pointer; }
    </style>
</head>
<body>

<div class="overlay" id="overlay">
    <h1>GAUSSIAN SYNTH V3</h1>
    <p>Click to Initialize Audio Engine</p>
</div>

<div class="synth-case">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <label style="color:#666; font-size:10px; width:auto;">
            <input type="checkbox" id="vizToggle" checked style="width:auto; accent-color:var(--accent);"> Enable Oscilloscope (CPU Heavy)
        </label>
    </div>
    <canvas id="scope"></canvas>
    
    <div class="dashboard">
        <div class="module">
            <h3>Oscillator</h3>
            <div class="control">
                <label>Waveform</label>
                <select id="wave"><option value="sawtooth">Sawtooth</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sine">Sine</option></select>
            </div>
            <div class="control">
                <label>Instability (σ) <span id="v_unc">15</span></label>
                <input type="range" id="uncertainty" min="0" max="100" value="15">
            </div>
        </div>

        <div class="module">
            <h3>Filter</h3>
            <div class="control">
                <label>Cutoff <span id="v_cut">2000</span></label>
                <input type="range" id="cutoff" min="50" max="8000" value="2000">
            </div>
            <div class="control">
                <label>Resonance (Q) <span id="v_q">1</span></label>
                <input type="range" id="q" min="0.1" max="20" step="0.1" value="1">
            </div>
        </div>

        <div class="module">
            <h3>Envelope (ADSR)</h3>
            <div class="control">
                <label>Attack <span id="v_a">0.02</span></label>
                <input type="range" id="attack" min="0.005" max="2" step="0.01" value="0.02">
            </div>
            <div class="control">
                <label>Release <span id="v_r">0.3</span></label>
                <input type="range" id="release" min="0.01" max="3" step="0.01" value="0.3">
            </div>
        </div>

        <div class="module">
            <h3>Dynamics</h3>
            <div class="control">
                <label>Decay <span id="v_d">0.1</span></label>
                <input type="range" id="decay" min="0.01" max="1" step="0.01" value="0.1">
            </div>
            <div class="control">
                <label>Sustain <span id="v_s">0.5</span></label>
                <input type="range" id="sustain" min="0" max="1" step="0.1" value="0.5">
            </div>
        </div>
    </div>

    <div class="keyboard" id="kb"></div>
</div>

<script>
    let audioCtx, analyser;
    const activeNotes = new Map();

    const notes = [
        {f: 261.63, k: 'a', t: 'white'}, {f: 277.18, k: 'w', t: 'black'},
        {f: 293.66, k: 's', t: 'white'}, {f: 311.13, k: 'e', t: 'black'},
        {f: 329.63, k: 'd', t: 'white'}, {f: 349.23, k: 'f', t: 'white'},
        {f: 369.99, k: 't', t: 'black'}, {f: 392.00, k: 'g', t: 'white'},
        {f: 415.30, k: 'y', t: 'black'}, {f: 440.00, k: 'h', t: 'white'},
        {f: 466.16, k: 'u', t: 'black'}, {f: 493.88, k: 'j', t: 'white'},
        {f: 523.25, k: 'k', t: 'white'}, {f: 554.37, k: 'o', t: 'black'},
        {f: 587.33, k: 'l', t: 'white'}
    ];

    function gaussian() {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function play(freq, key) {
        if(!audioCtx || activeNotes.has(key)) return;

        const σ = parseFloat(document.getElementById('uncertainty').value);
        const pitch = freq * Math.pow(2, (gaussian() * σ) / 1200);
        
        const osc = audioCtx.createOscillator();
        const flt = audioCtx.createBiquadFilter();
        const amp = audioCtx.createGain();

        // Settings
        osc.type = document.getElementById('wave').value;
        osc.frequency.value = pitch;
        flt.type = 'lowpass';
        flt.frequency.value = document.getElementById('cutoff').value;
        flt.Q.value = document.getElementById('q').value;

        // ADSR Logic
        const A = parseFloat(document.getElementById('attack').value);
        const D = parseFloat(document.getElementById('decay').value);
        const S = parseFloat(document.getElementById('sustain').value);
        const now = audioCtx.currentTime;

        amp.gain.setValueAtTime(0, now);
        amp.gain.linearRampToValueAtTime(0.4, now + A);
        amp.gain.exponentialRampToValueAtTime(S > 0 ? S * 0.4 : 0.001, now + A + D);

        osc.connect(flt).connect(amp).connect(analyser);
        osc.start();

        activeNotes.set(key, {osc, amp});
        document.getElementById('key-'+key).classList.add('active');
    }

    function stop(key) {
        if(!activeNotes.has(key)) return;
        const {osc, amp} = activeNotes.get(key);
        const R = parseFloat(document.getElementById('release').value);
        const now = audioCtx.currentTime;

        amp.gain.cancelScheduledValues(now);
        amp.gain.setValueAtTime(amp.gain.value, now);
        amp.gain.exponentialRampToValueAtTime(0.001, now + R);
        osc.stop(now + R + 0.1);

        activeNotes.delete(key);
        document.getElementById('key-'+key).classList.remove('active');
    }

    // UI & Keyboard Setup
    const kb = document.getElementById('kb');
    let bIdx = 0;
    notes.forEach(n => {
        const d = document.createElement('div');
        d.id = 'key-'+n.k;
        d.className = `key ${n.t} ${n.t === 'black' ? 'bk'+(bIdx++) : ''}`;
        d.onmousedown = () => play(n.f, n.k);
        d.onmouseup = () => stop(n.k);
        kb.appendChild(d);
    });

    window.onkeydown = e => { const n = notes.find(x => x.k === e.key.toLowerCase()); if(n) play(n.f, n.k); };
    window.onkeyup = e => stop(e.key.toLowerCase());

    // Visualizer Loop
    function draw() {
        const active = document.getElementById('vizToggle').checked;
        if (!active) {
            setTimeout(draw, 500);
            return;
        }

        requestAnimationFrame(draw);
        if(!analyser) return;

        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(data);
        const ctx = document.getElementById('scope').getContext('2d');
        ctx.fillStyle = '#000'; 
        ctx.fillRect(0,0,850,100);
        
        ctx.strokeStyle = '#00d2ff'; 
        ctx.lineWidth = 2; 
        ctx.beginPath();
        
        const width = 850;
        const sliceWidth = width / data.length;
        let x = 0;

        for(let i=0; i<data.length; i++) {
            const v = data[i] / 128.0;
            const y = v * 50;
            if(i === 0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
            x += sliceWidth;
        }
        ctx.stroke();
    }

    document.getElementById('overlay').onclick = function() {
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.connect(audioCtx.destination);
        this.style.display = 'none';
        draw();
    };

    // Label Updaters
    document.querySelectorAll('input').forEach(i => {
        i.oninput = e => { if(document.getElementById('v_'+e.target.id)) document.getElementById('v_'+e.target.id).innerText = e.target.value; };
    });
</script>
</body>
</html>
